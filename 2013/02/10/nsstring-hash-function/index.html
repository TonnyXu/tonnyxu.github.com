
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>NSString - Hash function - Learning Foundation.framework | Tonny Xu</title>
  <meta name="author" content="Tonny Xu">

  
  <meta name="description" content="The origin of -[NSString hash] function The -[NSString hash] function is actually defined by NSObject protocol(not the class), it defines -[NSObject &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://TonnyXu.github.com/2013/02/10/nsstring-hash-function/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Learning Foundation.framework | Tonny Xu" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-579328-7']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Learning Foundation.framework | Tonny Xu</a></h1>
  
    <h2>Life is like a box of chocolates...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:TonnyXu.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">NSString - Hash Function</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-10T18:40:00+09:00" pubdate data-updated="true">Feb 10<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>The origin of <code>-[NSString hash]</code> function</h2>

<p>The <code>-[NSString hash]</code> function is actually defined by NSObject protocol(not the class), it defines <code>-[NSObject hash]</code> as required. You can see it from <code>NSObject.h</code></p>

<figure class='code'><figcaption><span>the define of `-hash` function</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">@protocol</span> <span class="nc">NSObject</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isEqual:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">object</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span><span class="nf">hash</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// others ignored.</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And since NSObject class adopts <code>NSObject</code> protocol, hence every object definitely has a function called <code>-hash</code>. While different classes have different types of data, writing a universal hash function for all the classes is not possible, so the classes in <code>Foundation.framework</code> implemented different hash function by override NSObject class&#8217;s implementation.</p>

<p><a id="note64"></a>
One thing to be <strong>NOTED</strong>: the return type of <code>-[NSObject hash]</code> function is <code>NSUInteger</code>. Because <code>NSUInteger</code> has different sizes on x86 and x86_64 and ARM systems, when implement your own class&#8217;s hash function, don&#8217;t forget that.</p>

<h2>When this function will be used?</h2>

<p>When we write our code, we rarely use hash function directly. Why? Because it is usually used by container class <code>NSDictionary</code> which is wildly called <strong>hash table</strong>.</p>

<blockquote><p>If you want to have a deep understanding of <strong>hash table</strong>, please see the <a href="http://en.wikipedia.org/wiki/Hash_table">wikipedia page</a>.</p></blockquote>

<p>In short, hash table is a data structure that support O(1) <strong>data access</strong> by searching the <strong>key</strong>. Do reach that goal:</p>

<ol>
<li>The keys a hash table contains must be <strong>unique</strong>.</li>
<li>A particular key can always be <strong>hashed</strong> to the same value.</li>
</ol>


<p>One basic idea is that we can generate a integer hash value for each key so that each value is <strong>unique</strong>, and use this unique key to insert/delete/search the value. If the key is a decimal, that it would be easier, but numbers don&#8217;t have meanings. Using a string to represent a key will make our code(and our life) much more easier.</p>

<p>As a result, modern programing languages implemented hash table all support using a string as a key. That&#8217;s when the <code>NSString</code>&#8217;s hash function is used.</p>

<h2>How <code>NSString</code> implements the hash function?</h2>

<p>We talked about the key must be an <strong>unique decimal number</strong>. So the problem will be <strong>how to turn a string into a unique number without collisions</strong>. Actually this doesn&#8217;t turn out to be an easy task. Many computer scientists had researched this topic and see <a href="http://www.amazon.com/gp/product/0262533057/ref=as_li_ss_tl?ie=UTF8&amp;camp=1789&amp;creative=390957&amp;creativeASIN=0262533057&amp;linkCode=as2&amp;tag=totonet-20">Introduction to algorithms, chapter 11</a>(a.k.a. CLRS) for details.</p>

<p>To understand how <code>NSString</code> implements the hash function, the best way is reading the source code, and Apple released the source code of <code>CoreFunction</code> which includes <code>CFString</code>, a toll-free bridge object to <code>NSString</code>, we can see the <a href="http://opensource.apple.com/source/CF/CF-744.12/CFString.c">source code of CFString</a> now.</p>

<h3>Step 1: Grab the source code</h3>

<p>To grab the source code, just access <a href="http://opensource.apple.com/">http://opensource.apple.com/</a>, navigate to a particular Mac OS X release, search for <strong>CF-</strong>, then you will find a link on the right to download the source code.</p>

<h3>Step 2: Open the source tree and navigate to <code>CFString.c</code></h3>

<p>Using vim/emacs or any text editor you like. There are 4 <em>public</em> functions defined:</p>

<figure class='code'><figcaption><span>4 hash functions defined in CFString</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">CFStringHashCString</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">bytes</span><span class="p">,</span> <span class="n">CFIndex</span> <span class="n">len</span><span class="p">)</span>
</span><span class='line'><span class="n">CFStringHashCharacters</span><span class="p">(</span><span class="k">const</span> <span class="n">UniChar</span> <span class="o">*</span><span class="n">characters</span><span class="p">,</span> <span class="n">CFIndex</span> <span class="n">len</span><span class="p">)</span>
</span><span class='line'><span class="n">CFStringHashISOLatin1CString</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">bytes</span><span class="p">,</span> <span class="n">CFIndex</span> <span class="n">len</span><span class="p">)</span>
</span><span class='line'><span class="n">CFStringHashNSString</span><span class="p">(</span><span class="n">CFStringRef</span> <span class="n">str</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the start point of our journey.</p>

<h3>Step 3: Let the journey begin</h3>

<p>Let&#8217;s take a deep look into the <code>CFStringHashNSString(CFStringRef str)</code> because from what the function name tells, it&#8217;s the function we are looking for.</p>

<p><a id="list1"></a></p>

<figure class='code'><figcaption><span>List 1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* This is meant to be called from NSString or subclassers only. It is an error for this to be called without the ObjC runtime or an argument which is not an NSString or subclass. It can be called with NSCFString, although that would be inefficient (causing indirection) and won&#39;t normally happen anyway, as NSCFString overrides hash.</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="n">CFHashCode</span> <span class="nf">CFStringHashNSString</span><span class="p">(</span><span class="n">CFStringRef</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">UniChar</span> <span class="n">buffer</span><span class="p">[</span><span class="n">HashEverythingLimit</span><span class="p">];</span>
</span><span class='line'>    <span class="n">CFIndex</span> <span class="n">bufLen</span><span class="p">;</span>      <span class="c1">// Number of characters in the buffer for hashing</span>
</span><span class='line'>    <span class="n">CFIndex</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// Actual length of the string</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">len</span> <span class="o">=</span> <span class="n">CF_OBJC_CALLV</span><span class="p">((</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">HashEverythingLimit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">CF_OBJC_CALLV</span><span class="p">((</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">,</span> <span class="n">getCharacters</span><span class="o">:</span><span class="n">buffer</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
</span><span class='line'>        <span class="n">bufLen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">CF_OBJC_CALLV</span><span class="p">((</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">,</span> <span class="n">getCharacters</span><span class="o">:</span><span class="n">buffer</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span><span class='line'>        <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">CF_OBJC_CALLV</span><span class="p">((</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">,</span> <span class="n">getCharacters</span><span class="o">:</span><span class="n">buffer</span><span class="o">+</span><span class="mi">32</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">((</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span><span class='line'>        <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">CF_OBJC_CALLV</span><span class="p">((</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">,</span> <span class="n">getCharacters</span><span class="o">:</span><span class="n">buffer</span><span class="o">+</span><span class="mi">64</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span><span class='line'>        <span class="n">bufLen</span> <span class="o">=</span> <span class="n">HashEverythingLimit</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">__CFStrHashCharacters</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bufLen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the comment at the beginning of this function. Because <code>NSCFString</code> is completely private, we don&#8217;t have a chance to see how <code>NSCFString</code> to implement this. But, this function also clearly demonstrates how to implement a hash function, so let&#8217;s continue our journey with this function.</p>

<h4>The define of <code>HashEverythingLimit</code></h4>

<p>Basically, the <code>if</code> clause divides this function into 2 parts. The length of the string is more than <code>HashEverythingLimit</code> or not.
<code>HashEverythingLimit</code> is defined as:</p>

<p><a id="list2"></a></p>

<figure class='code'><figcaption><span>List 2</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* String hashing: Should give the same results whatever the encoding; so we hash UniChars.</span>
</span><span class='line'><span class="cm">If the length is less than or equal to 96, then the hash function is simply the </span>
</span><span class='line'><span class="cm">following (n is the nth UniChar character, starting from 0):</span>
</span><span class='line'><span class="cm">   </span>
</span><span class='line'><span class="cm">  hash(-1) = length</span>
</span><span class='line'><span class="cm">  hash(n) = hash(n-1) * 257 + unichar(n);</span>
</span><span class='line'><span class="cm">  Hash = hash(length-1) * ((length &amp; 31) + 1)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">If the length is greater than 96, then the above algorithm applies to </span>
</span><span class='line'><span class="cm">characters 0..31, (length/2)-16..(length/2)+15, and length-32..length-1, inclusive;</span>
</span><span class='line'><span class="cm">thus the first, middle, and last 32 characters.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">Note that the loops below are unrolled; and: 257^2 = 66049; 257^3 = 16974593; 257^4 = 4362470401;  67503105 is 257^4 - 256^4</span>
</span><span class='line'><span class="cm">If hashcode is changed from UInt32 to something else, this last piece needs to be readjusted.  </span>
</span><span class='line'><span class="cm">!!! We haven&#39;t updated for LP64 yet</span>
</span><span class='line'>
</span><span class='line'><span class="cm">NOTE: The hash algorithm used to be duplicated in CF and Foundation; but now it should only be in the four functions below.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">Hash function was changed between Panther and Tiger, and Tiger and Leopard.</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="cp">#define HashEverythingLimit 96</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define HashNextFourUniChars(accessStart, accessEnd, pointer) \</span>
</span><span class='line'><span class="cp">    {result = result * 67503105 + (accessStart 0 accessEnd) * 16974593  + (accessStart 1 accessEnd) * 66049  + (accessStart 2 accessEnd) * 257 + (accessStart 3 accessEnd); pointer += 4;}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define HashNextUniChar(accessStart, accessEnd, pointer) \</span>
</span><span class='line'><span class="cp">    {result = result * 257 + (accessStart 0 accessEnd); pointer++;}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The reason I post other context is because the comment before <code>HashEverythingLimit</code> well explained how apple&#8217;s guys were thinking.</p>

<ol>
<li>If the string is less than 96 characters, hash it directly.</li>
<li>If the string has more than 96 characters, get the first, middle, last 32 characters to form a 96 characters string, then hash the 96 characters string.</li>
</ol>


<p>You can see the code in the <a href="#gist">gist</a> below.</p>

<p>This explains what the <code>if</code> clause is doing in <a href="#list1">List 1</a>.</p>

<h4>This inline function does the real work</h4>

<p>Back to <a href="#list1">List 1</a>, we can see the <code>if</code> clause is actually forming a temp string buffer to be used to calculate the hash value. The real work is done in <code>return</code> line.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">return</span> <span class="nf">__CFStrHashCharacters</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bufLen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, let&#8217;s see what this line function <code>__CFStrHashCharacters</code> really does.</p>

<p><a id="list3"></a></p>

<figure class='code'><figcaption><span>List 3: __CFStrHashCharacters</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* In this function, actualLen is the length of the original string; but len is the number of characters in buffer. The buffer is expected to contain the parts of the string relevant to hashing.</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="n">CF_INLINE</span> <span class="n">CFHashCode</span> <span class="nf">__CFStrHashCharacters</span><span class="p">(</span><span class="k">const</span> <span class="n">UniChar</span> <span class="o">*</span><span class="n">uContents</span><span class="p">,</span> <span class="n">CFIndex</span> <span class="n">len</span><span class="p">,</span> <span class="n">CFIndex</span> <span class="n">actualLen</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">CFHashCode</span> <span class="n">result</span> <span class="o">=</span> <span class="n">actualLen</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">HashEverythingLimit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">const</span> <span class="n">UniChar</span> <span class="o">*</span><span class="n">end4</span> <span class="o">=</span> <span class="n">uContents</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
</span><span class='line'>        <span class="k">const</span> <span class="n">UniChar</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">uContents</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">uContents</span> <span class="o">&lt;</span> <span class="n">end4</span><span class="p">)</span> <span class="n">HashNextFourUniChars</span><span class="p">(</span><span class="n">uContents</span><span class="p">[,</span> <span class="p">],</span> <span class="n">uContents</span><span class="p">);</span>    <span class="c1">// First count in fours</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">uContents</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="n">HashNextUniChar</span><span class="p">(</span><span class="n">uContents</span><span class="p">[,</span> <span class="p">],</span> <span class="n">uContents</span><span class="p">);</span>      <span class="c1">// Then for the last &lt;4 chars, count in ones...</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">const</span> <span class="n">UniChar</span> <span class="o">*</span><span class="n">contents</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
</span><span class='line'>  <span class="n">contents</span> <span class="o">=</span> <span class="n">uContents</span><span class="p">;</span>
</span><span class='line'>        <span class="n">end</span> <span class="o">=</span> <span class="n">contents</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">contents</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="n">HashNextFourUniChars</span><span class="p">(</span><span class="n">contents</span><span class="p">[,</span> <span class="p">],</span> <span class="n">contents</span><span class="p">);</span>
</span><span class='line'>  <span class="n">contents</span> <span class="o">=</span> <span class="n">uContents</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
</span><span class='line'>        <span class="n">end</span> <span class="o">=</span> <span class="n">contents</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">contents</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="n">HashNextFourUniChars</span><span class="p">(</span><span class="n">contents</span><span class="p">[,</span> <span class="p">],</span> <span class="n">contents</span><span class="p">);</span>
</span><span class='line'>  <span class="n">end</span> <span class="o">=</span> <span class="n">uContents</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>        <span class="n">contents</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">contents</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="n">HashNextFourUniChars</span><span class="p">(</span><span class="n">contents</span><span class="p">[,</span> <span class="p">],</span> <span class="n">contents</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span> <span class="o">+</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">actualLen</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s take a close look at this method, the whole thing before <code>return</code> is to calculate a fairly large number <code>result</code>, than add another large value by left shifting <code>result</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">return</span> <span class="n">result</span> <span class="o">+</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">actualLen</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note there are some programming technicals used here, especially an unusual usage of macro:</p>

<p>With the definition of <code>HashNextUniChar</code> as</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define HashNextUniChar(accessStart, accessEnd, pointer) \</span>
</span><span class='line'><span class="cp">    {result = result * 257 + (accessStart 0 accessEnd); pointer++;}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">HashNextUniChar</span><span class="p">(</span><span class="n">uContents</span><span class="p">[,</span> <span class="p">],</span> <span class="n">uContents</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>will be expanded to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">{</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="mi">257</span> <span class="o">+</span> <span class="n">uContents</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">uContents</span><span class="o">++</span><span class="p">;}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>That&#8217;s it</strong>.</p>

<h2>Verify the hash function</h2>

<p>So far, we understand how the hash value of a NSString is generated. Since the root function is <code>CFStringHashNSString</code> we can place a symbolic breakpoint on this function and <code>__CFStringHash</code> in Xcode and see what will happen. Note that the core function to calculate the hash value <code>__CFStrHashCharacters</code> in <a href="#list3">List 3</a> is marked <code>CF_INLINE</code> we could not put a breakpoint on this function.</p>

<p><img src="/images/Screen%20Shot%202013-02-10%20at%208.28.54%20PM.png" alt="image of putting a symbolic breakpoint" /></p>

<p>I wrote a simple function to see the differences of 2 functions: <code>-[NSString hash]</code> and <code>CFStringHashNSString</code>.</p>

<p><a id="gist"></a></p>

<div><script src='https://gist.github.com/4749305.js'></script>
<noscript><pre><code></code></pre></noscript></div>




<div><script src='https://gist.github.com/4749305.js?file=[output.txt]'></script>
<noscript><pre><code>2013-02-10 21:12:57.704 NSStringHash[25996:303] 3294171457232409974
2013-02-10 21:12:57.707 NSStringHash[25996:303] -1315859082
2013-02-10 21:12:57.707 NSStringHash[25996:303] -1315859082
2013-02-10 21:12:57.707 NSStringHash[25996:303] 2DB73F7CB1919576
2013-02-10 21:12:57.708 NSStringHash[25996:303] FFFFFFFFB1919576
2013-02-10 21:12:57.708 NSStringHash[25996:303] FFFFFFFFB1919576
2013-02-10 21:12:57.708 NSStringHash[25996:303] -8069816457736624960
2013-02-10 21:12:57.709 NSStringHash[25996:303] -8069816457736624960
2013-02-10 21:12:57.709 NSStringHash[25996:303] 900240AFFA01E4C0
2013-02-10 21:12:57.710 NSStringHash[25996:303] 900240AFFA01E4C0</code></pre></noscript></div>


<p>If see the output, did you remember I mentioned to differences between 32bit system and 64bit system <a href="#note64">before</a>?</p>

<p>The hash value returned by <code>CFStringHashNSString</code> is actually a 32bit unsigned integer, while <code>-[NSString hash]</code> does return a 64bit unsigned integer in 64bit system. If we look at <a href="#list2">List 2</a> again, we will see that Apple&#8217;s engineer noted that they haven&#8217;t implemented <code>LP64</code> yet.</p>

<p>And the last demo code shows if you calculate the hash value for 2 strings longer than 96 characters but have the same characters in first, middle, last 32 characters, we did get 2 hash codes <strong>exactly the same</strong>.</p>

<h2>Problems left</h2>

<p>But if we put a breakpoint on <code>__CFStringHash</code> function, we will see it does get called when <code>-[NSString hash]</code> is called. And if we call <code>__CFStringHash</code> directly we got the same result as <code>CFStringHashNSString</code>. Looks like the way we pass in the parameter to <code>__CFStringHash</code> is wrong.</p>

<p>Now I&#8217;m not so clear about how get a 64bit long hash value when we call <code>__CFStringHash</code> or <code>CFStringHashNSString</code> directly. If anyone knows, please leave a message.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Tonny Xu</span></span>

      








  


<time datetime="2013-02-10T18:40:00+09:00" pubdate data-updated="true">Feb 10<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/nsstring/'>NSString</a>, <a class='category' href='/blog/categories/algorithm/'>algorithm</a>, <a class='category' href='/blog/categories/hash/'>hash</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://TonnyXu.github.com/2013/02/10/nsstring-hash-function/" data-via="TonnyXu" data-counturl="http://TonnyXu.github.com/2013/02/10/nsstring-hash-function/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2012/12/24/learning-foundation-dot-framework/" title="Previous Post: Learning Foundation.framework">&laquo; Learning Foundation.framework</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/02/10/nsstring-hash-function/">NSString - Hash function</a>
      </li>
    
      <li class="post">
        <a href="/2012/12/24/learning-foundation-dot-framework/">Learning Foundation.framework</a>
      </li>
    
      <li class="post">
        <a href="/2012/11/21/finished-setting-up-octopress/">Finished setting up Octopress</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/TonnyXu">@TonnyXu</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'TonnyXu',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("TonnyXu", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/TonnyXu" class="twitter-follow-button" data-show-count="false">Follow @TonnyXu</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Tonny Xu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'TonnyXu';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://TonnyXu.github.com/2013/02/10/nsstring-hash-function/';
        var disqus_url = 'http://TonnyXu.github.com/2013/02/10/nsstring-hash-function/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
